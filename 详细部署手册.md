# AI量化加密货币交易系统 - 详细部署手册

## 1. 项目概述

### 1.1 系统架构
- **前端**: React + TypeScript + TDesign UI组件库
- **后端**: FastAPI + Python 3.9+ + 异步处理
- **数据库**: PostgreSQL + Redis + InfluxDB + MongoDB
- **消息队列**: Redis Pub/Sub + Kafka
- **监控**: Prometheus + Grafana + 自定义监控
- **部署**: Docker + Nginx + 宝塔面板

### 1.2 核心功能模块
- 多交易所API集成（币安、欧意、Coinbase等）
- AI策略引擎（传统策略 + 机器学习）
- 实时风险管理
- 智能订单路由
- WebSocket实时数据推送
- 回测系统
- 性能监控和告警

## 2. 环境准备和依赖安装

### 2.1 服务器配置要求
```bash
# 系统要求
操作系统: CentOS 7.9+ / Ubuntu 18.04+
CPU: 4核+ (推荐8核)
内存: 8GB+ (推荐16GB)
存储: 100GB+ SSD (推荐NVMe SSD)
带宽: 10Mbps+ (推荐100Mbps)
```

### 2.2 宝塔面板安装和配置

#### 2.2.1 安装宝塔面板
```bash
# CentOS 7.x
curl -sSO http://download.bt.cn/install/install_6.0.sh && bash install_6.0.sh

# Ubuntu 18.04+
wget -O install.sh http://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh

# 安装完成后记录面板地址、用户名和密码
```

#### 2.2.2 宝塔面板软件安装
登录宝塔面板后，安装以下软件：

1. **Nginx 1.20+**
   - 用于反向代理和静态文件服务
   - 配置SSL证书和HTTPS

2. **Docker管理器**
   - 用于容器化部署
   - 管理Docker镜像和容器

3. **PostgreSQL 15**
   - 主数据库，存储用户数据和交易记录

4. **Redis 7.2**
   - 缓存和消息队列

5. **PM2管理器**
   - Node.js进程管理（用于前端服务）

### 2.3 系统环境配置

#### 2.3.1 创建专用用户
```bash
# 创建专用用户
groupadd trading
useradd -m -g trading -s /bin/bash trader
passwd trader

# 添加sudo权限
usermod -aG sudo trader

# 切换到专用用户
su - trader
```

#### 2.3.2 优化系统参数
```bash
# 编辑系统参数
cat >> /etc/sysctl.conf << EOF
# 网络优化
net.core.somaxconn = 65535
net.core.netdev_max_backlog = 65535
net.ipv4.tcp_max_syn_backlog = 65535
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_tw_recycle = 1

# 内存优化
vm.swappiness = 10
vm.dirty_ratio = 60
vm.dirty_background_ratio = 2

# 文件描述符
fs.file-max = 1000000
EOF

# 应用配置
sysctl -p

# 设置文件描述符限制
cat >> /etc/security/limits.conf << EOF
* soft nofile 65535
* hard nofile 65535
* soft nproc 65535
* hard nproc 65535
EOF
```

## 3. 项目文件部署

### 3.1 创建项目目录结构
```bash
# 创建项目目录
mkdir -p /www/wwwroot/ai-trading/{logs,data,config,models,backup}
cd /www/wwwroot/ai-trading

# 设置目录权限
chown -R www:www /www/wwwroot/ai-trading
chmod -R 755 /www/wwwroot/ai-trading
chmod 644 /www/wwwroot/ai-trading/config/*
chmod 600 /www/wwwroot/ai-trading/.env
```

### 3.2 上传项目文件
将以下目录和文件上传到对应位置：

```
/www/wwwroot/ai-trading/
├── agents/                    # AI代理模块
│   ├── agent_orchestrator.py
│   ├── base_agent.py
│   └── trend_agent.py
├── backtest/                  # 回测系统
├── config/                    # 配置管理
│   ├── api_config.py         # API密钥配置
│   ├── exchanges.py          # 交易所配置
│   ├── trading_config.py     # 交易配置
│   └── risk_config.py        # 风控配置
├── core/                      # 核心框架
├── data/                      # 数据层
├── deploy/                    # 部署配置
├── execution/                 # 执行层
├── monitoring/                # 监控系统
├── risk_management/           # 风控系统
├── scripts/                   # 启动脚本
├── strategies/               # 策略层
├── tests/                     # 测试
├── web_app/                   # Web应用
├── .env.example              # 环境变量模板
├── docker-compose.prod.yml   # 生产编排
├── Dockerfile                # Docker镜像
├── requirements.txt          # Python依赖
└── pyproject.toml            # 项目配置
```

### 3.3 环境变量配置

#### 3.3.1 创建环境变量文件
```bash
cd /www/wwwroot/ai-trading
cp .env.example .env
chmod 600 .env
```

#### 3.3.2 配置环境变量
编辑 `.env` 文件：

```env
# ==================== 应用配置 ====================
APP_ENV=production
LOG_LEVEL=INFO
DEBUG=false

# ==================== 网络配置 ====================
WEB_HOST=0.0.0.0
WEB_PORT=8000
API_PREFIX=/api/v1

# ==================== 数据库配置 ====================
# PostgreSQL
DB_HOST=localhost
DB_PORT=5432
DB_NAME=ai_trading
DB_USER=ai_trader
DB_PASSWORD=your_secure_password_123

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=your_redis_password_123
REDIS_DB=0

# InfluxDB
INFLUXDB_URL=http://localhost:8086
INFLUXDB_TOKEN=ai-trading-token-123
INFLUXDB_ORG=ai-trading
INFLUXDB_BUCKET=trading_data

# MongoDB
MONGODB_URL=mongodb://ai_trader:your_mongo_password_123@localhost:27017/ai_trading

# ==================== 交易所API配置 ====================
# 币安 (必须配置)
BINANCE_API_KEY=your_binance_api_key
BINANCE_API_SECRET=your_binance_secret
BINANCE_SANDBOX=false

# 欧意 (可选)
OKX_API_KEY=your_okx_api_key
OKX_API_SECRET=your_okx_secret
OKX_PASSPHRASE=your_okx_passphrase
OKX_SANDBOX=false

# Coinbase (可选)
COINBASE_API_KEY=your_coinbase_api_key
COINBASE_API_SECRET=your_coinbase_secret

# Bybit (可选)
BYBIT_API_KEY=your_bybit_api_key
BYBIT_API_SECRET=your_bybit_secret

# ==================== 数据API配置 ====================
# Twitter API (可选)
TWITTER_BEARER_TOKEN=your_twitter_bearer_token
TWITTER_API_KEY=your_twitter_api_key
TWITTER_API_SECRET=your_twitter_api_secret

# Etherscan API (可选)
ETHERSCAN_API_KEY=your_etherscan_api_key

# ==================== 安全配置 ====================
SECRET_KEY=your_jwt_secret_key_32_chars_long
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=1440

# ==================== 性能配置 ====================
WORKER_COUNT=4
MAX_CONNECTIONS=1000
BACKLOG=2048

# ==================== 监控配置 ====================
PROMETHEUS_PORT=8001
GRAFANA_PASSWORD=admin123
ALERT_WEBHOOK=https://your-webhook-url.com/alert
```

### 3.4 接口对接详细配置

#### 3.4.1 交易所API接口配置

**币安API配置步骤：**
1. 登录币安官网 (https://www.binance.com)
2. 进入"API管理"页面
3. 创建新的API密钥
4. 设置IP白名单（服务器IP地址）
5. 启用交易权限
6. 复制API Key和Secret到环境变量

**欧意API配置步骤：**
1. 登录欧意官网 (https://www.okx.com)
2. 进入"API管理"页面
3. 创建新的API密钥
4. 设置交易权限和IP白名单
5. 设置交易密码（Passphrase）
6. 复制API Key、Secret和Passphrase到环境变量

#### 3.4.2 数据API接口配置

**Twitter API配置：**
1. 申请Twitter开发者账号 (https://developer.twitter.com)
2. 创建新的应用
3. 获取Bearer Token
4. 配置API Key和Secret

**Etherscan API配置：**
1. 注册Etherscan账号 (https://etherscan.io)
2. 申请API密钥
3. 设置使用限制

## 4. 数据库配置和初始化

### 4.1 PostgreSQL数据库配置

#### 4.1.1 通过宝塔面板配置
1. 登录宝塔面板
2. 进入"数据库"页面
3. 添加PostgreSQL数据库
4. 设置数据库名称：`ai_trading`
5. 设置用户名：`ai_trader`
6. 设置强密码（建议16位以上）
7. 记录连接信息

#### 4.1.2 数据库优化配置
```sql
-- 连接宝塔面板的PostgreSQL
psql -U postgres

-- 创建专用数据库和用户
CREATE DATABASE ai_trading;
CREATE USER ai_trader WITH PASSWORD 'your_secure_password_123';
GRANT ALL PRIVILEGES ON DATABASE ai_trading TO ai_trader;

-- 优化配置
ALTER SYSTEM SET shared_buffers = '2GB';
ALTER SYSTEM SET work_mem = '64MB';
ALTER SYSTEM SET maintenance_work_mem = '512MB';
ALTER SYSTEM SET effective_cache_size = '6GB';
ALTER SYSTEM SET max_connections = 200;
ALTER SYSTEM SET random_page_cost = 1.1;
ALTER SYSTEM SET effective_io_concurrency = 200;

-- 重启PostgreSQL生效
SELECT pg_reload_conf();
```

### 4.2 Redis配置

#### 4.2.1 宝塔面板Redis配置
1. 进入宝塔面板"软件商店"
2. 安装Redis 7.2
3. 设置密码：`your_redis_password_123`
4. 配置内存限制：2GB
5. 启用持久化

#### 4.2.2 Redis优化配置
```bash
# 编辑Redis配置文件
cat >> /etc/redis/redis.conf << 'EOF'
# 内存优化
maxmemory 2gb
maxmemory-policy allkeys-lru

# 持久化配置
save 900 1
save 300 10
save 60 10000
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb

# 网络优化
tcp-keepalive 300
timeout 0

# 性能优化
hz 10
activerehashing yes
EOF

# 重启Redis
systemctl restart redis
```

### 4.3 数据库初始化

#### 4.3.1 创建数据库表结构
```bash
cd /www/wwwroot/ai-trading
python scripts/init_database.py
```

#### 4.3.2 验证数据库连接
```python
# 测试脚本：test_db_connection.py
import psycopg2
import redis
from influxdb_client import InfluxDBClient
from pymongo import MongoClient

def test_postgres():
    try:
        conn = psycopg2.connect(
            host='localhost',
            database='ai_trading',
            user='ai_trader',
            password='your_secure_password_123'
        )
        print("✅ PostgreSQL连接成功")
        conn.close()
        return True
    except Exception as e:
        print(f"❌ PostgreSQL连接失败: {e}")
        return False

def test_redis():
    try:
        r = redis.Redis(
            host='localhost',
            port=6379,
            password='your_redis_password_123',
            decode_responses=True
        )
        r.ping()
        print("✅ Redis连接成功")
        return True
    except Exception as e:
        print(f"❌ Redis连接失败: {e}")
        return False

if __name__ == "__main__":
    test_postgres()
    test_redis()
```

## 5. Docker容器化部署

### 5.1 Docker环境准备

#### 5.1.1 安装Docker和Docker Compose
```bash
# 安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 启动Docker服务
sudo systemctl enable docker
sudo systemctl start docker

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 验证安装
docker --version
docker-compose --version
```

#### 5.1.2 配置Docker镜像加速
```bash
# 创建Docker配置目录
sudo mkdir -p /etc/docker

# 配置镜像加速器
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com",
    "https://registry.docker-cn.com"
  ],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m",
    "max-file": "3"
  }
}
EOF

# 重启Docker
sudo systemctl daemon-reload
sudo systemctl restart docker
```

### 5.2 构建Docker镜像

#### 5.2.1 构建应用镜像
```bash
cd /www/wwwroot/ai-trading

# 构建生产镜像
docker build -t ai-trading:latest -f Dockerfile .

# 验证镜像构建
docker images | grep ai-trading
```

#### 5.2.2 创建Docker网络
```bash
# 创建专用网络
docker network create trading_network

# 验证网络创建
docker network ls | grep trading_network
```

### 5.3 启动Docker服务

#### 5.3.1 使用Docker Compose启动
```bash
cd /www/wwwroot/ai-trading

# 启动所有服务
docker-compose -f docker-compose.prod.yml up -d

# 查看服务状态
docker-compose -f docker-compose.prod.yml ps

# 查看服务日志
docker-compose -f docker-compose.prod.yml logs -f web_app
```

#### 5.3.2 服务健康检查
```bash
# 检查服务健康状态
curl -f http://localhost:8000/health

# 检查数据库连接
docker exec ai_trading_postgres pg_isready -U ai_trader -d ai_trading

# 检查Redis连接
docker exec ai_trading_redis redis-cli -a your_redis_password_123 ping
```

## 6. Nginx反向代理配置

### 6.1 宝塔面板网站配置

#### 6.1.1 创建网站
1. 登录宝塔面板
2. 进入"网站"页面
3. 点击"添加站点"
4. 填写域名（或使用IP地址）
5. 根目录：`/www/wwwroot/ai-trading/web_app/static`
6. PHP版本：纯静态
7. 创建数据库：选择之前创建的数据库

#### 6.1.2 配置反向代理
在网站设置中添加反向代理：

```nginx
# API接口反向代理
location /api/ {
    proxy_pass http://127.0.0.1:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # 超时设置
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    # 缓冲设置
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
}

# WebSocket反向代理
location /ws/ {
    proxy_pass http://127.0.0.1:8000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    
    # WebSocket超时设置
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
}

# 静态文件服务
location /static/ {
    alias /www/wwwroot/ai-trading/web_app/static/;
    expires 1y;
    add_header Cache-Control "public, immutable";
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/xml+rss
        application/json;
}

# 前端路由处理
location / {
    try_files $uri $uri/ /index.html;
    
    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
}

# 健康检查接口
location /health {
    proxy_pass http://127.0.0.1:8000/health;
    access_log off;
}
```

### 6.2 SSL证书配置

#### 6.2.1 申请SSL证书
1. 进入宝塔面板"网站"设置
2. 选择对应网站
3. 点击"SSL"选项卡
4. 选择"Let's Encrypt"免费证书
5. 勾选需要绑定的域名
6. 点击"申请"
7. 勾选"强制HTTPS"

#### 6.2.2 HTTPS优化配置
```nginx
# HTTPS服务器配置
server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;
    
    # SSL证书路径
    ssl_certificate /www/server/panel/vhost/cert/your-domain.com/fullchain.pem;
    ssl_certificate_key /www/server/panel/vhost/cert/your-domain.com/privkey.pem;
    
    # SSL优化配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # 安全头
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    
    # 其他配置与HTTP相同
    # ...
}

# HTTP重定向到HTTPS
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

## 7. 系统服务配置和监控

### 7.1 PM2进程管理

#### 7.1.1 安装和配置PM2
```bash
# 安装PM2
npm install pm2 -g

# 创建PM2配置文件
cat > /www/wwwroot/ai-trading/ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'ai-trading-web',
    script: 'python',
    args: 'web_app/main.py',
    cwd: '/www/wwwroot/ai-trading',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PYTHONPATH: '/www/wwwroot/ai-trading'
    },
    error_file: '/www/wwwroot/ai-trading/logs/pm2-error.log',
    out_file: '/www/wwwroot/ai-trading/logs/pm2-out.log',
    log_file: '/www/wwwroot/ai-trading/logs/pm2-combined.log',
    time: true
  }, {
    name: 'ai-trading-data',
    script: 'python',
    args: 'scripts/start_data_collection.py',
    cwd: '/www/wwwroot/ai-trading',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '512M',
    env: {
      NODE_ENV: 'production',
      PYTHONPATH: '/www/wwwroot/ai-trading'
    }
  }]
}
EOF

# 启动PM2服务
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

#### 7.1.2 创建系统服务
```bash
# 创建系统服务文件
sudo tee /etc/systemd/system/ai-trading.service << 'EOF'
[Unit]
Description=AI Trading System
After=network.target docker.service
Requires=docker.service

[Service]
Type=forking
User=trader
Group=trading
WorkingDirectory=/www/wwwroot/ai-trading
ExecStart=/usr/bin/pm2 start ecosystem.config.js
ExecReload=/usr/bin/pm2 reload ecosystem.config.js
ExecStop=/usr/bin/pm2 stop ecosystem.config.js
Restart=always
RestartSec=10

# 环境变量
Environment=PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin
Environment=PYTHONPATH=/www/wwwroot/ai-trading

# 安全设置
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/www/wwwroot/ai-trading/logs /www/wwwroot/ai-trading/data

[Install]
WantedBy=multi-user.target
EOF

# 启用服务
sudo systemctl daemon-reload
sudo systemctl enable ai-trading.service
sudo systemctl start ai-trading.service

# 检查服务状态
sudo systemctl status ai-trading.service
```

### 7.2 监控和告警配置

#### 7.2.1 Prometheus监控配置
```yaml
# deploy/prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "rules/*.yml"

scrape_configs:
  - job_name: 'ai-trading'
    static_configs:
      - targets: ['web_app:8001']
    metrics_path: '/metrics'
    scrape_interval: 10s
    
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres:5432']
    
  - job_name: 'redis'
    static_configs:
      - targets: ['redis:6379']
```

#### 7.2.2 Grafana仪表板配置
1. 访问Grafana: http://your-domain.com:3000
2. 登录: admin / admin123
3. 添加数据源: Prometheus (http://prometheus:9090)
4. 导入预置仪表板

#### 7.2.3 自定义监控脚本
```python
# monitoring/custom_monitor.py
import psutil
import requests
from datetime import datetime

class SystemMonitor:
    def __init__(self):
        self.metrics = {}
    
    def collect_system_metrics(self):
        """收集系统指标"""
        self.metrics['cpu_percent'] = psutil.cpu_percent(interval=1)
        self.metrics['memory_percent'] = psutil.virtual_memory().percent
        self.metrics['disk_usage'] = psutil.disk_usage('/').percent
        self.metrics['network_io'] = psutil.net_io_counters()
        self.metrics['timestamp'] = datetime.now().isoformat()
        
        return self.metrics
    
    def check_service_health(self):
        """检查服务健康状态"""
        services = {
            'web_app': 'http://localhost:8000/health',
            'postgres': '检查数据库连接',
            'redis': '检查Redis连接'
        }
        
        health_status = {}
        for service, endpoint in services.items():
            try:
                if service == 'web_app':
                    response = requests.get(endpoint, timeout=5)
                    health_status[service] = response.status_code == 200
                else:
                    # 其他服务的健康检查逻辑
                    health_status[service] = True
            except Exception as e:
                health_status[service] = False
                print(f"{service}健康检查失败: {e}")
        
        return health_status
```

## 8. 安全配置和防火墙

### 8.1 防火墙配置

#### 8.1.1 宝塔面板防火墙配置
1. 进入宝塔面板"安全"页面
2. 配置防火墙规则：
   - 开放端口: 22 (SSH), 80 (HTTP), 443 (HTTPS), 8000 (应用)
   - 限制其他端口访问
   - 设置IP白名单

#### 8.1.2 系统防火墙配置
```bash
# 配置防火墙
sudo ufw enable
sudo ufw default deny incoming
sudo ufw default allow outgoing

# 开放必要端口
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw allow 8000/tcp  # 应用端口

# 查看防火墙状态
sudo ufw status verbose
```

### 8.2 SSH安全加固
```bash
# 编辑SSH配置
sudo nano /etc/ssh/sshd_config

# 修改以下配置
Port 2222                          # 修改SSH端口
PermitRootLogin no                 # 禁止root登录
PasswordAuthentication no          # 禁用密码认证
PubkeyAuthentication yes          # 启用密钥认证
MaxAuthTries 3                     # 最大认证尝试次数
ClientAliveInterval 300           # 客户端存活检查间隔
ClientAliveCountMax 2             # 客户端存活检查次数

# 重启SSH服务
sudo systemctl restart sshd
```

### 8.3 应用安全配置

#### 8.3.1 API安全配置
```python
# config/security.py
from fastapi import Security, HTTPException
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from jose import JWTError, jwt

security = HTTPBearer()

async def verify_token(credentials: HTTPAuthorizationCredentials = Security(security)):
    """验证JWT令牌"""
    try:
        payload = jwt.decode(
            credentials.credentials, 
            SECRET_KEY, 
            algorithms=[ALGORITHM]
        )
        return payload
    except JWTError:
        raise HTTPException(
            status_code=401,
            detail="Invalid authentication credentials"
        )
```

#### 8.3.2 请求限流配置
```python
# config/rate_limit.py
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address
from slowapi.errors import RateLimitExceeded

limiter = Limiter(key_func=get_remote_address)

# 应用限流配置
app.state.limiter = limiter
app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)

# API限流配置
@router.get("/api/data")
@limiter.limit("10/minute")
async def get_data(request: Request):
    return {"data": "限流测试"}
```

## 9. 测试和验证

### 9.1 服务健康检查

#### 9.1.1 基础服务检查
```bash
# 检查Docker服务状态
docker ps
docker-compose -f docker-compose.prod.yml ps

# 检查应用健康状态
curl -f http://localhost:8000/health
curl -f https://your-domain.com/api/health

# 检查数据库连接
psql -h localhost -U ai_trader -d ai_trading -c "SELECT version();"

# 检查Redis连接
redis-cli -h localhost -p 6379 -a your_redis_password_123 ping
```

#### 9.1.2 API接口测试
```bash
# 测试基础API
curl -X GET "https://your-domain.com/api/v1/health"
curl -X GET "https://your-domain.com/api/v1/account/balance"
curl -X GET "https://your-domain.com/api/v1/strategies"

# 测试WebSocket连接
wscat -c "wss://your-domain.com/ws/trading"

# 性能测试
ab -n 1000 -c 10 "https://your-domain.com/api/v1/market/ticker?symbol=BTCUSDT"
```

### 9.2 功能完整性测试

#### 9.2.1 交易所连接测试
```python
# scripts/test_exchange_connection.py
import ccxt
from config.api_config import API_CONFIG

def test_exchange_connection():
    """测试交易所连接"""
    exchanges = {
        'binance': {
            'apiKey': API_CONFIG.exchanges.binance_api_key,
            'secret': API_CONFIG.exchanges.binance_secret_key,
            'sandbox': False
        },
        'okx': {
            'apiKey': API_CONFIG.exchanges.okx_api_key,
            'secret': API_CONFIG.exchanges.okx_secret_key,
            'password': API_CONFIG.exchanges.okx_passphrase,
            'sandbox': False
        }
    }
    
    for exchange_name, config in exchanges.items():
        try:
            exchange = getattr(ccxt, exchange_name)(config)
            exchange.fetch_balance()
            print(f"✅ {exchange_name} 连接成功")
        except Exception as e:
            print(f"❌ {exchange_name} 连接失败: {e}")

if __name__ == "__main__":
    test_exchange_connection()
```

#### 9.2.2 策略回测测试
```python
# scripts/test_backtest.py
from backtest.base_backtester import BaseBacktester
from strategies.ma_crossover import MACrossoverStrategy

def test_backtest():
    """测试策略回测"""
    try:
        strategy = MACrossoverStrategy()
        backtester = BaseBacktester(strategy)
        
        # 运行回测
        results = backtester.run_backtest(
            symbol='BTC/USDT',
            start_date='2024-01-01',
            end_date='2024-01-31',
            initial_capital=10000
        )
        
        print("✅ 回测测试成功")
        print(f"总收益率: {results['total_return']:.2%}")
        print(f"夏普比率: {results['sharpe_ratio']:.2f}")
        
    except Exception as e:
        print(f"❌ 回测测试失败: {e}")

if __name__ == "__main__":
    test_backtest()
```

## 10. 常见问题解决方案

### 10.1 部署问题

#### 问题1: 端口冲突
**症状**: 服务启动失败，端口被占用
**解决方案**:
```bash
# 检查端口占用
netstat -tulpn | grep :8000

# 修改应用端口
# 编辑 .env 文件，修改 WEB_PORT=8001

# 修改Nginx配置
# 更新反向代理配置中的端口号
```

#### 问题2: 数据库连接失败
**症状**: 应用无法连接数据库
**解决方案**:
```bash
# 检查数据库服务状态
systemctl status postgresql

# 检查连接权限
psql -h localhost -U postgres -c "\l"

# 修改连接配置
# 编辑 .env 文件，检查数据库连接参数
# 修改 pg_hba.conf 添加连接规则
```

### 10.2 接口对接问题

#### 问题3: 交易所API连接失败
**症状**: 无法获取市场数据或执行交易
**解决方案**:
1. 检查API密钥是否正确
2. 验证IP白名单设置
3. 检查API权限设置
4. 确认网络连接正常

#### 问题4: WebSocket连接中断
**症状**: 实时数据推送中断
**解决方案**:
1. 检查Nginx WebSocket配置
2. 验证防火墙设置
3. 检查网络稳定性
4. 配置重连机制

### 10.3 性能问题

#### 问题5: 内存不足
**症状**: 服务频繁重启，系统卡顿
**解决方案**:
```bash
# 查看内存使用
free -h

# 优化Docker内存限制
docker update --memory=2g --memory-swap=4g ai_trading_web

# 增加交换空间
sudo fallocate -l 4G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

#### 问题6: 数据库性能问题
**症状**: 查询响应慢，超时
**解决方案**:
```sql
-- 优化数据库配置
ALTER SYSTEM SET shared_buffers = '4GB';
ALTER SYSTEM SET work_mem = '128MB';

-- 创建索引
CREATE INDEX idx_trades_symbol_time ON trades(symbol, timestamp);
CREATE INDEX idx_orders_status ON orders(status);

-- 分析查询性能
EXPLAIN ANALYZE SELECT * FROM trades WHERE symbol = 'BTCUSDT';
```

## 11. 备份和恢复

### 11.1 数据库备份策略

#### 11.1.1 自动备份脚本
```bash
# /root/backup_trading.sh
#!/bin/bash

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/ai-trading"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份PostgreSQL
pg_dump -h localhost -U ai_trader ai_trading > $BACKUP_DIR/ai_trading_$DATE.sql

# 备份Redis
redis-cli -h localhost -p 6379 -a your_redis_password_123 --rdb $BACKUP_DIR/dump_$DATE.rdb

# 压缩备份文件
tar -czf $BACKUP_DIR/backup_$DATE.tar.gz $BACKUP_DIR/*_$DATE.*

# 清理旧备份（保留7天）
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete

# 记录备份日志
echo "备份完成: $DATE" >> $BACKUP_DIR/backup.log
```

#### 11.1.2 定时备份任务
```bash
# 添加定时任务
crontab -e

# 每天凌晨2点执行备份
0 2 * * * /root/backup_trading.sh

# 每周日执行完整备份
0 3 * * 0 /root/backup_trading.sh full
```

### 11.2 应用代码备份
```bash
# 备份整个应用目录
tar -czf /backup/ai-trading-code-$(date +%Y%m%d).tar.gz /www/wwwroot/ai-trading/

# 备份配置文件
cp -r /www/wwwroot/ai-trading/config /backup/config-backup-$(date +%Y%m%d)

# 备份Docker镜像
docker save ai-trading:latest > /backup/ai-trading-image-$(date +%Y%m%d).tar
```

## 12. 维护和更新

### 12.1 日常维护任务

#### 12.1.1 日志监控和清理
```bash
# 查看应用日志
tail -f /www/wwwroot/ai-trading/logs/app.log

# 清理旧日志
find /www/wwwroot/ai-trading/logs -name "*.log" -mtime +7 -delete

# 监控错误日志
grep -i "error" /www/wwwroot/ai-trading/logs/app.log | tail -20
```

#### 12.1.2 性能监控
```bash
# 监控系统资源
top
htop

# 监控Docker资源
docker stats

# 监控数据库性能
pg_stat_activity
pg_stat_statements
```

### 12.2 系统更新

#### 12.2.1 代码更新流程
```bash
# 备份当前版本
cd /www/wwwroot/ai-trading
tar -czf ../backup/ai-trading-$(date +%Y%m%d).tar.gz .

# 拉取最新代码
git pull origin main

# 更新依赖
pip install -r requirements.txt --upgrade

# 重启服务
docker-compose -f docker-compose.prod.yml down
docker-compose -f docker-compose.prod.yml up -d

# 验证更新
curl -f http://localhost:8000/health
```

#### 12.2.2 安全更新
```bash
# 更新系统补丁
sudo apt update && sudo apt upgrade -y

# 更新Docker镜像
docker-compose -f docker-compose.prod.yml pull

# 更新Python依赖安全包
pip list --outdated | grep -E "(security|vulnerability)" | cut -d' ' -f1 | xargs pip install -U
```

---

## 附录

### A. 配置文件模板
完整的配置文件模板请参考项目中的 `.env.example` 文件

### B. 技术支持
- 项目文档: `/www/wwwroot/ai-trading/docs/`
- 错误日志: `/www/wwwroot/ai-trading/logs/`
- 技术支持: contact@ai-trading.com

### C. 重要提醒
1. **安全第一**: 加密货币交易具有高风险，务必在模拟环境中充分测试
2. **定期备份**: 设置自动备份策略，防止数据丢失
3. **监控告警**: 配置完善的监控系统，及时发现和处理问题
4. **版本控制**: 使用Git进行版本管理，便于回滚和更新
5. **合规性**: 确保遵守当地法律法规和交易所规定

---

**文档版本**: v2.0  
**最后更新**: 2024-01-19  
**维护团队**: AI Trading System Team