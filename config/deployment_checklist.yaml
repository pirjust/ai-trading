# AI量化交易系统部署检查清单
# 用于自动化部署检查和验证

version: "2.0"
description: "AI量化交易系统部署检查清单"

checks:
  # 前置检查
  pre_deployment:
    - name: "服务器资源检查"
      type: "system"
      commands:
        - "df -h | grep /$"
        - "free -h"
        - "nproc"
      requirements:
        disk_space: "10GB"
        memory: "4GB"
        cpu_cores: "2"
      
    - name: "网络连接检查"
      type: "network"
      commands:
        - "ping -c 3 8.8.8.8"
        - "curl -I https://api.github.com"
      requirements:
        internet: true
        github_access: true
      
    - name: "服务端口检查"
      type: "network"
      commands:
        - "netstat -tlnp | grep :80"
        - "netstat -tlnp | grep :8000"
        - "netstat -tlnp | grep :5432"
        - "netstat -tlnp | grep :6379"
      requirements:
        ports_free: [80, 8000, 5432, 6379]

  # 部署过程检查
  deployment:
    - name: "代码完整性检查"
      type: "code"
      commands:
        - "git status"
        - "git log -1 --oneline"
        - "find . -name '*.py' | wc -l"
      requirements:
        git_clean: true
        python_files: "> 50"
      
    - name: "依赖安装检查"
      type: "code"
      commands:
        - "python -c \"import sys; print(sys.version)\""
        - "pip list | wc -l"
        - "pip check"
      requirements:
        python_version: ">= 3.9"
        packages_installed: "> 20"
        dependency_conflicts: false
      
    - name: "前端构建检查"
      type: "frontend"
      commands:
        - "cd frontend && npm --version"
        - "ls -la frontend/dist/"
      requirements:
        npm_installed: true
        dist_files: "> 10"

  # 部署后检查
  post_deployment:
    - name: "服务状态检查"
      type: "service"
      commands:
        - "systemctl status nginx"
        - "systemctl status postgresql"
        - "systemctl status redis"
        - "supervisorctl status"
      requirements:
        nginx_running: true
        postgresql_running: true
        redis_running: true
        supervisor_running: true
      
    - name: "应用健康检查"
      type: "application"
      commands:
        - "curl -f http://127.0.0.1:8000/health"
        - "curl -f http://127.0.0.1:8000/docs"
      requirements:
        api_healthy: true
        docs_accessible: true
      
    - name: "数据库连接检查"
      type: "database"
      commands:
        - "psql -h localhost -U ai_trader -d ai_trading -c \"SELECT version();\""
        - "redis-cli -h localhost -a $REDIS_PASSWORD ping"
      requirements:
        postgresql_connected: true
        redis_connected: true
      
    - name: "监控指标检查"
      type: "monitoring"
      commands:
        - "curl -f http://127.0.0.1:8000/metrics"
        - "ps aux | grep trading_monitor"
      requirements:
        metrics_available: true
        monitor_running: true

  # 安全检查
  security:
    - name: "防火墙配置检查"
      type: "security"
      commands:
        - "ufw status"
        - "iptables -L"
      requirements:
        firewall_enabled: true
        ports_protected: [22, 80, 443]
      
    - name: "SSL证书检查"
      type: "security"
      commands:
        - "openssl x509 -in /etc/ssl/certs/ai-trading.crt -text -noout"
        - "curl -I https://$DOMAIN"
      requirements:
        ssl_cert_valid: true
        https_accessible: true

# 检查结果配置
results:
  success_threshold: 0.8  # 80%检查通过视为成功
  warning_threshold: 0.6  # 60%检查通过视为警告
  
  # 检查结果处理
  on_success:
    - "发送成功通知"
    - "记录部署日志"
    - "更新部署状态"
  
  on_warning:
    - "发送警告通知"
    - "记录检查结果"
    - "建议修复"
  
  on_failure:
    - "发送失败通知"
    - "停止部署流程"
    - "执行回滚"

# 通知配置
notifications:
  slack:
    webhook_url: "$SLACK_WEBHOOK_URL"
    channel: "#deployments"
  
  email:
    smtp_server: "smtp.gmail.com"
    port: 587
    username: "$EMAIL_USERNAME"
    password: "$EMAIL_PASSWORD"
  
  webhook:
    url: "$WEBHOOK_URL"
    timeout: 30

# 环境特定配置
environments:
  production:
    domain: "trading.yourdomain.com"
    api_url: "https://api.trading.yourdomain.com"
    database:
      host: "localhost"
      port: 5432
      name: "ai_trading_prod"
    redis:
      host: "localhost"
      port: 6379
    
  staging:
    domain: "staging.trading.yourdomain.com"
    api_url: "https://staging.api.trading.yourdomain.com"
    database:
      host: "localhost"
      port: 5432
      name: "ai_trading_staging"
    redis:
      host: "localhost"
      port: 6379

# 部署验证脚本
validation_scripts:
  - "scripts/deployment_checklist.py"
  - "scripts/health_check.py"
  - "scripts/security_check.py"

# 自动修复配置
auto_fix:
  enabled: true
  max_attempts: 3
  
  fixes:
    - name: "重启失败的服务"
      condition: "service_status == 'failed'"
      command: "systemctl restart {service}"
    
    - name: "清理磁盘空间"
      condition: "disk_usage > 90"
      command: "find /var/log -name '*.log' -mtime +7 -delete"
    
    - name: "重启数据库连接"
      condition: "db_connection_failed"
      command: "systemctl restart postgresql"

# 部署历史记录
deployment_history:
  keep_count: 10
  backup_before_deploy: true
  rollback_enabled: true

# 监控指标阈值
monitoring_thresholds:
  cpu_usage: 80
  memory_usage: 85
  disk_usage: 90
  response_time: 5000  # 5秒
  error_rate: 1  # 1%

# 日志配置
logging:
  level: "INFO"
  file: "/var/log/ai-trading-deployment.log"
  max_size: "100MB"
  backup_count: 5

# 性能优化配置
performance:
  workers: 4
  threads: 2
  max_requests: 1000
  timeout: 120

# 安全配置
security:
  ssl_enabled: true
  hsts_enabled: true
  cors_enabled: true
  rate_limiting:
    enabled: true
    requests_per_minute: 100